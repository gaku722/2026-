<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Portal & Media Tool</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .formula { font-family: 'Times New Roman', serif; font-style: italic; }
    </style>
</head>
<body class="bg-gray-50 text-slate-900 min-h-screen">

    <!-- ヘッダー：学習ポータルとしてのデザイン -->
    <nav class="bg-indigo-900 text-white px-6 h-16 flex items-center justify-between sticky top-0 z-50 shadow-md">
        <div class="flex items-center gap-3">
            <div class="bg-white p-1.5 rounded-lg shadow-sm">
                <i data-lucide="graduation-cap" class="text-indigo-900 w-6 h-6"></i>
            </div>
            <h1 class="font-bold text-lg tracking-tight">学習支援ポータル <span class="text-indigo-200 font-normal text-sm ml-2">Study & Tools</span></h1>
        </div>
        <div id="auth-status" class="flex items-center gap-2 text-[10px] font-bold text-indigo-200">
            <i data-lucide="book-open" class="w-3 h-3"></i> 集中モード
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- メインエリア：学習コンテンツ (Math, Social Studies etc.) -->
            <div class="lg:col-span-8 space-y-8">
                
                <!-- 数学セクション -->
                <section class="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
                    <div class="flex items-center gap-3 mb-6 border-b pb-4">
                        <i data-lucide="variable" class="text-blue-600 w-6 h-6"></i>
                        <h3 class="text-xl font-black">数学：重要公式リファレンス</h3>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                            <h4 class="font-bold text-blue-800 mb-2">二次方程式の解の公式</h4>
                            <p class="formula text-xl text-center py-4 bg-white rounded-xl shadow-inner">
                                $x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$
                            </p>
                            <p class="text-xs text-blue-600 mt-2">※判別式 $D = b^2 - 4ac$ の符号で解の個数が決まります。</p>
                        </div>
                        <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
                            <h4 class="font-bold text-indigo-800 mb-2">三平方の定理（ピタゴラス）</h4>
                            <p class="formula text-xl text-center py-4 bg-white rounded-xl shadow-inner">
                                $a^2 + b^2 = c^2$
                            </p>
                            <p class="text-xs text-indigo-600 mt-2">直角三角形の斜辺 $c$ と他の2辺の関係式です。</p>
                        </div>
                    </div>
                </section>

                <!-- 社会セクション -->
                <section class="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
                    <div class="flex items-center gap-3 mb-6 border-b pb-4">
                        <i data-lucide="landmark" class="text-emerald-600 w-6 h-6"></i>
                        <h3 class="text-xl font-black">社会：日本の歴史時代区分</h3>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center gap-4 p-4 hover:bg-emerald-50 rounded-2xl transition-colors">
                            <div class="bg-emerald-100 text-emerald-700 font-bold px-4 py-1 rounded-full text-sm">鎌倉時代</div>
                            <p class="text-sm text-slate-600 font-medium">1185年頃〜。源頼朝が幕府を開き、武家政治が始まった時代。</p>
                        </div>
                        <div class="flex items-center gap-4 p-4 hover:bg-emerald-50 rounded-2xl transition-colors">
                            <div class="bg-emerald-100 text-emerald-700 font-bold px-4 py-1 rounded-full text-sm">江戸時代</div>
                            <p class="text-sm text-slate-600 font-medium">1603年〜。徳川家康による長期安定政権。鎖国と独自の文化が発展。</p>
                        </div>
                        <div class="flex items-center gap-4 p-4 hover:bg-emerald-50 rounded-2xl transition-colors">
                            <div class="bg-emerald-100 text-emerald-700 font-bold px-4 py-1 rounded-full text-sm">明治維新</div>
                            <p class="text-sm text-slate-600 font-medium">1868年。文明開化が進み、日本が近代国家へと歩み出した転換点。</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- サイドエリア：YouTube機能（ちっちゃい角に配置） -->
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-slate-900 text-white rounded-[2rem] p-6 shadow-xl sticky top-24">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-black text-lg flex items-center gap-2">
                            <i data-lucide="video" class="text-red-500"></i> 学習動画ツール
                        </h3>
                        <span class="text-[10px] bg-white/10 px-2 py-0.5 rounded text-slate-400 font-bold uppercase tracking-wider">Tool</span>
                    </div>

                    <!-- URL入力フォーム -->
                    <form id="analyze-form" class="space-y-4 mb-6">
                        <div class="relative">
                            <input
                                type="text"
                                id="url-input"
                                class="w-full p-4 pl-10 bg-white/10 border border-white/20 rounded-2xl outline-none focus:border-red-500 transition-all text-sm placeholder:text-slate-500"
                                placeholder="YouTubeのURLをペースト..."
                            >
                            <i data-lucide="link" class="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-500 w-4 h-4"></i>
                        </div>
                        <button
                            type="submit"
                            id="analyze-btn"
                            class="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl transition-all shadow-md active:scale-95 text-sm"
                        >
                            <span id="btn-text">動画を読み込む</span>
                        </button>
                    </form>

                    <p id="error-msg" class="text-red-400 text-[10px] font-bold hidden mb-4 text-center"></p>

                    <!-- プレイヤー・ダウンロードエリア -->
                    <div id="result-area" class="hidden space-y-4">
                        <div class="aspect-video bg-black rounded-xl overflow-hidden shadow-inner border border-white/10">
                            <iframe
                                id="video-player"
                                src=""
                                class="w-full h-full"
                                frameborder="0"
                                allow="autoplay; encrypted-media"
                                allowfullscreen
                            ></iframe>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="download('720')" class="bg-white/10 hover:bg-white/20 p-3 rounded-xl transition-all text-center group">
                                <i data-lucide="download" class="w-4 h-4 mx-auto mb-1 text-slate-400 group-hover:text-white"></i>
                                <span class="text-[10px] font-bold block">MP4保存</span>
                            </button>
                            <button onclick="download('mp3')" class="bg-white/10 hover:bg-white/20 p-3 rounded-xl transition-all text-center group">
                                <i data-lucide="music" class="w-4 h-4 mx-auto mb-1 text-slate-400 group-hover:text-white"></i>
                                <span class="text-[10px] font-bold block">MP3保存</span>
                            </button>
                        </div>
                        
                        <button id="copy-btn" class="w-full py-2 bg-indigo-600/50 hover:bg-indigo-600 rounded-lg text-[10px] font-bold transition-all flex items-center justify-center gap-2">
                            <i data-lucide="share-2" class="w-3 h-3"></i> 共有URLをコピー
                        </button>
                    </div>

                    <!-- 履歴セクション（さらに小さく表示） -->
                    <div class="mt-8 pt-6 border-t border-white/10">
                        <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i data-lucide="history" class="w-3 h-3"></i> 学習履歴
                        </h4>
                        <div id="history-list" class="space-y-1.5">
                            <!-- 履歴 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Firebase初期設定
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'study-sync-app';
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let currentUrl = "";

        // 認証
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            } catch (err) { console.error("Auth error:", err); }
        }

        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) loadHistory();
        });

        function loadHistory() {
            const historyCol = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('search_history');
            historyCol.onSnapshot((snapshot) => {
                const items = snapshot.docs.map(d => d.data());
                const sorted = items.sort((a, b) => b.timestamp - a.timestamp).slice(0, 4);
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                sorted.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-2 hover:bg-white/5 rounded-lg text-[10px] text-slate-400 flex items-center justify-between group truncate";
                    btn.innerHTML = `<span>ID: ${item.id}</span> <i data-lucide="play" class="w-2 h-2 opacity-0 group-hover:opacity-100"></i>`;
                    btn.onclick = () => {
                        document.getElementById('url-input').value = item.url;
                        analyze(item.url);
                    };
                    list.appendChild(btn);
                });
                lucide.createIcons();
            });
        }

        async function analyze(url) {
            const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i);
            const id = match ? match[1] : null;

            if (!id) {
                const err = document.getElementById('error-msg');
                err.innerText = "有効なリンクではありません。";
                err.classList.remove('hidden');
                return;
            }

            currentUrl = url;
            document.getElementById('error-msg').classList.add('hidden');
            document.getElementById('btn-text').innerHTML = '<div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin mx-auto"></div>';

            if (currentUser) {
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('search_history').doc(id).set({
                        id: id, url: url, timestamp: Date.now()
                    });
                } catch (err) { console.error("Save error:", err); }
            }

            setTimeout(() => {
                document.getElementById('btn-text').innerText = "動画を読み込む";
                document.getElementById('video-player').src = `https://www.youtube-nocookie.com/embed/${id}?autoplay=0&rel=0`;
                document.getElementById('result-area').classList.remove('hidden');
                lucide.createIcons();
            }, 600);
        }

        window.download = function(format) {
            if (!currentUrl) return;
            window.open(`https://loader.to/api/button/?url=${encodeURIComponent(currentUrl)}&f=${format}`, '_blank');
        };

        document.getElementById('analyze-form').onsubmit = (e) => {
            e.preventDefault();
            analyze(document.getElementById('url-input').value);
        };

        document.getElementById('copy-btn').onclick = () => {
            const textArea = document.createElement("textarea");
            textArea.value = window.location.href;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert("共有リンクをコピーしました");
        };

        initAuth();
        lucide.createIcons();
    </script>
</body>
</html>
